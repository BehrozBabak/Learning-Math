// app_v4.js - simplified improved version with tutorial and combination handling (as earlier in design)
const AUDIO_FILES = { welcome: 'sounds/welcome.wav', correct: 'sounds/correct.wav', wrong: 'sounds/wrong.wav', hint: 'sounds/hint.wav', start_exam: 'sounds/start_exam.wav', congrats: 'sounds/congrats.wav' };
const audioCache = {}; function loadAudio(name,path){ const a=new Audio(path); a.preload='auto'; audioCache[name]=a; } Object.entries(AUDIO_FILES).forEach(([k,p])=> loadAudio(k,p));
function playAudioKey(key){ try{ if(!window.STATE || !window.STATE.soundOn) return; }catch(e){} const a=audioCache[key]; if(a && a.play){ try{ a.currentTime=0; a.play(); return; }catch(e){} } const phrases = { welcome:'سلام! من اسب تک‌شاخم، بیا با هم ریاضی‌بازی کنیم. آماده‌ای؟', correct:'آفرین! خیلی خوب شد.', wrong:'نه، اشکالی نداره، دوباره تلاش کن.', hint:'راهنما: از شکل‌ها کمک بگیر و یک‌بار آرام بشمار.', start_exam:'آزمون شروع شد. ده سوال داری؛ جواب‌ها را انتخاب کن.', congrats:'تبریک! کارت عالی بود، آفرین بهت!' }; if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(phrases[key]||''); u.lang='fa-IR'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); } }
window.STATE={ op:null, level:'مبتدی', mixed:false, examMode:false, idx:0, score:0, soundOn:true, musicOn:false, tutorial:false };
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function symbol(op){ return ({'جمع':'+','تفریق':'-','ضرب':'×','تقسیم':'÷'})[op] || '?'; }
function makeSingle(op,level){ let a,b,answer,display,hint; const ranges={'مبتدی':9,'متوسط':99,'پیشرفته':99}; const R=ranges[level]||99; if(op==='ترکیبی') op=['جمع','تفریق','ضرب','تقسیم'][rand(0,3)]; if(op==='جمع'||op==='تفریق'){ a=rand(-R,R); b=rand(-R,R); answer=(op==='جمع')?a+b:a-b; display=`${a} ${op==='جمع'?'+':'-'} ${b} = ?`; hint=(op==='جمع')?'همه را با هم بشمار':'از عدد اول، دومی را کم کن'; } else if(op==='ضرب'){ const MR=(level==='مبتدی')?9:(level==='متوسط'?20:30); a=rand(-MR,MR); b=rand(-MR,MR); answer=a*b; display=`${a} × ${b} = ?`; hint='ضرب یعنی جمع تکراری'; } else if(op==='تقسیم'){ const MR=(level==='مبتدی')?9:(level==='متوسط'?12:20); b=rand(1,MR)*(Math.random()<0.15?-1:1); const q=rand(-MR,MR); a=b*q; answer=(b===0)?0:a/b; display=`${a} ÷ ${b} = ?`; hint='تقسیم یعنی پخش مساوی'; } return {op,a,b,answer:String(answer),display,hint}; }
function makeCombined(level){ const ops=['جمع','تفریق','ضرب','تقسیم']; const nOps=rand(2,3); function pickNum(){ return (level==='مبتدی')?rand(-9,9):rand(-99,99); } let a=pickNum(), b=pickNum(), c=pickNum(); let op1=ops[rand(0,3)], op2=ops[rand(0,3)]; if(op1==='تقسیم'){ let divisor=(level==='مبتدی')?rand(1,9):rand(1,12); let q=pickNum(); a=divisor*q; b=divisor; } if(op2==='تقسیم'){ let divisor=(level==='مبتدی')?rand(1,9):rand(1,12); let q=pickNum(); c=divisor*q; } let expr=''; if(nOps===2){ if(Math.random()<0.5) expr=`(${a} ${symbol(op1)} ${b}) ${symbol(op2)} ${c}`; else expr=`${a} ${symbol(op1)} (${b} ${symbol(op2)} ${c})`; } else expr=`(${a} ${symbol(op1)} ${b}) ${symbol(op2)} ${c}`; const safe = expr.replace(/×/g,'*').replace(/÷/g,'/'); let val=0; try{ val=eval(safe); }catch(e){ val=0; } return {expr,answer:String(val),display:expr+' = ?',hint:'ابتدا پرانتزها را حساب کن.'}; }
function makeQuestion(mode,level){ if(mode==='ترکیبی') return makeCombined(level); else return makeSingle(mode,level); }
const elQ=document.getElementById('qtext'), elVisual=document.getElementById('visual'), elChoices=document.getElementById('choices'), elScore=document.getElementById('score'), elFeedback=document.getElementById('feedback');
let current=null;
function renderVisual(q){ elVisual.innerHTML=''; const shapesOn=document.getElementById('chk-show-shapes') && document.getElementById('chk-show-shapes').checked; if(!shapesOn) return; try{ if(q.display.indexOf('+')!==-1||q.display.indexOf('-')!==-1){ const nums=q.display.match(/-?\d+/g)||[]; nums.slice(0,2).forEach((n,i)=>{ const cnt=Math.min(Math.abs(Number(n)),12); for(let j=0;j<cnt;j++){ const d=document.createElement('div'); d.className='shape'; d.textContent = i===0? '🍎':'🍓'; elVisual.appendChild(d); } if(i===0){ const plus=document.createElement('div'); plus.className='shape plus'; plus.textContent='+'; elVisual.appendChild(plus); } }); } else if(q.display.indexOf('×')!==-1){ const nums=q.display.match(/-?\d+/g)||[]; const a=Math.min(Math.abs(Number(nums[0])||1),8); const b=Math.min(Math.abs(Number(nums[1])||1),8); const wrap=document.createElement('div'); wrap.style.display='grid'; wrap.style.gridTemplateColumns=`repeat(${b},26px)`; wrap.style.gap='4px'; for(let r=0;r<a;r++){ for(let c=0;c<b;c++){ const s=document.createElement('div'); s.className='shape'; s.textContent='⭐'; wrap.appendChild(s); } } elVisual.appendChild(wrap); } else if(q.display.indexOf('÷')!==-1){ const nums=q.display.match(/-?\d+/g)||[]; const a=Math.abs(Number(nums[0]||0)); const b=Math.abs(Number(nums[1]||1)); const group=document.createElement('div'); group.className='small'; group.textContent=`تقسیم ${a} بین ${b} نفر`; elVisual.appendChild(group); } else { const txt=document.createElement('div'); txt.className='small'; txt.textContent = q.display.replace('= ?',''); elVisual.appendChild(txt); } }catch(e){} }
function showTutorial(q){ const showSteps=document.getElementById('chk-step-tutorial') && document.getElementById('chk-step-tutorial').checked; if(!showSteps) return; const area=document.getElementById('feedback'); area.innerHTML=''; if(q.display.indexOf('+')!==-1) area.textContent='راهنما: هر دو عدد را با هم جمع کن.'; else if(q.display.indexOf('-')!==-1) area.textContent='راهنما: از عدد اول، عدد دوم را کم کن.'; else if(q.display.indexOf('×')!==-1) area.textContent='راهنما: ضرب یعنی جمع تکراری؛ مثلاً ۳×۴ یعنی ۳+۳+۳+۳'; else if(q.display.indexOf('÷')!==-1) area.textContent='راهنما: تقسیم یعنی پخش مساوی بین گروه‌ها.'; else area.textContent='ابتدا پرانتزها را حساب کن، سپس ضرب و تقسیم، بعد جمع و تفریق.'; }
function ask(mode,level){ current=makeQuestion(mode,level); elQ.innerHTML = `<span dir=\"ltr\"><strong>${current.display}</strong></span>`; renderVisual(current); showTutorial(current); elChoices.innerHTML=''; const correct=Number(current.answer); const opts=new Set([String(correct)]); while(opts.size<4){ let delta=rand(1, Math.max(2, Math.abs(correct)||5)); if(Math.random()<0.5) delta = Math.floor(delta*(0.3+Math.random())); let fake = correct + (Math.random()<0.5? delta : -delta); if(Math.abs(fake)>9999) fake = Math.sign(fake)*(9999-rand(0,100)); opts.add(String(fake)); } const arr=Array.from(opts).sort(()=>Math.random()-0.5); arr.forEach(opt=>{ const b=document.createElement('button'); b.className='choice'; b.textContent=opt; b.onclick=()=>checkAnswer(opt); elChoices.appendChild(b); }); if(window.STATE.soundOn){ if(window.STATE.examMode) playAudioKey('start_exam'); else playAudioKey('welcome'); } }
function checkAnswer(opt){ const correct=String(current.answer); if(opt===correct){ document.getElementById('feedback').textContent='آفرین! درست گفتی 🎉'; playAudioKey('correct'); confettiBurst(); window.STATE.score++; document.getElementById('score').textContent=window.STATE.score; } else { document.getElementById('feedback').textContent='نه، اشکالی نداره، دوباره تلاش کن.'; playAudioKey('wrong'); } }
function confettiBurst(){ try{ const container=document.createElement('div'); container.className='confetti'; document.body.appendChild(container); const colors=['#ff9ad8','#ffd6a5','#a7f3d0','#c7d2fe']; for(let i=0;i<30;i++){ const c=document.createElement('div'); c.className='c'; c.style.background=colors[Math.floor(Math.random()*colors.length)]; c.style.left=Math.random()*100+'%'; c.style.top='0'; c.style.width=(6+Math.random()*8)+'px'; c.style.height=(10+Math.random()*12)+'px'; container.appendChild(c); c.animate([{transform:'translateY(0) rotate(0)'},{transform:`translateY(${200+Math.random()*400}px) rotate(${Math.random()*720}deg)`}],{duration:1200+Math.random()*800}); setTimeout(()=>c.remove(),2200);} setTimeout(()=>container.remove(),2500);}catch(e){} }
document.querySelectorAll('.op').forEach(b=> b.addEventListener('click', ()=>{ const op=b.dataset.op; window.STATE.op=op; window.STATE.mixed=(op==='ترکیبی'); document.getElementById('mode-badge').textContent = window.STATE.mixed? 'وضعیت: ترکیبی' : `وضعیت: ${op}`; window.STATE.idx=0; window.STATE.score=0; document.getElementById('score').textContent='0'; ask(op, window.STATE.level); }));
document.querySelectorAll('.lvl').forEach(b=> b.addEventListener('click', ()=>{ document.querySelectorAll('.lvl').forEach(x=>x.setAttribute('aria-pressed','false')); b.setAttribute('aria-pressed','true'); const lvl=b.dataset.lvl; window.STATE.level=lvl; document.getElementById('level-badge').textContent=`سطح: ${lvl}`; if(window.STATE.soundOn) playAudioKey('welcome'); }));
document.getElementById('btn-next').addEventListener('click', ()=>{ if(!window.STATE.op){ playAudioKey('hint'); document.getElementById('feedback').textContent='اول یکی از عملیات را انتخاب کن.'; return; } ask(window.STATE.mixed? 'ترکیبی' : window.STATE.op, window.STATE.level); });
document.getElementById('btn-exam').addEventListener('click', ()=>{ if(!window.STATE.op && !window.STATE.mixed){ document.getElementById('feedback').textContent='اول یکی از عملیات را انتخاب کن.'; playAudioKey('hint'); return; } window.STATE.examMode=true; window.STATE.idx=0; window.STATE.score=0; document.getElementById('score').textContent='0'; playAudioKey('start_exam'); ask(window.STATE.mixed? 'ترکیبی' : window.STATE.op, window.STATE.level); });
document.getElementById('btn-sound').addEventListener('click', ()=>{ window.STATE.soundOn=!window.STATE.soundOn; document.getElementById('btn-sound').setAttribute('aria-pressed', window.STATE.soundOn); document.getElementById('btn-sound').textContent = window.STATE.soundOn? '🔊 صدا روشن':'🔇 صدا خاموش'; });
document.getElementById('btn-tutorial').addEventListener('click', ()=>{ const v=!window.STATE.tutorial; window.STATE.tutorial=v; document.getElementById('btn-tutorial').textContent = v? '📘 حالت آموزش: روشن' : '📘 حالت آموزش'; document.getElementById('chk-step-tutorial').checked = v; });
window.addEventListener('load', ()=>{ playAudioKey('welcome'); document.getElementById('qtext').focus(); });